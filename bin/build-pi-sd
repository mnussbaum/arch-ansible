#!/bin/bash

set -o errexit
set -o nounset

if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]] ; then
  echo "Builds an SD card to provision a Raspberry Pi B+" >&2
  echo "" >&2
  echo "--wipe-card, -w      Wipe all SD card partitions clean" >&2
  echo "" >&2
  echo "--no-clean,  -n      Don't clean up mounts and containers after run. Eases debugging" >&2
  exit
else
  set -o xtrace
fi

extra_ansible_args=""
boot_dir=/tmp/arch-pi-boot
root_dir=/var/lib/machines/arch-pi

for arg in "$@"
do
  case $arg in
    -n|--no-clean)
      extra_ansible_args="$extra_ansible_args -e no_clean='true'"
      shift
      ;;
    -w|--wipe-card)
      extra_ansible_args="$extra_ansible_args -e wipe_card='true'"
      shift
      ;;
  esac
done

if [[ "${1:-}" == "--wipe-card" ]] || [[ "${1:-}" == "-w" ]] ; then
  sudo rm -rf "$boot_dir"
  sudo rm -rf "$root_dir"
  shift
fi

extra_ansible_args="$extra_ansible_args -e boot_dir_mnt=$boot_dir -e root_dir_mnt=$root_dir"

ANSIBLE_PLAYBOOK=build-pi-sd.yml \
  exec ./bin/ansible \
  -e sd_device=/dev/mmcblk0 \
  -e pass_gpg_key="mnussbaum (Password Store)" \
  $extra_ansible_args \
  $@
