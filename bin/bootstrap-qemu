#! /bin/bash

set -o errexit
set -o nounset

if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]] ; then
  echo "Run ansible in an arch ISO running in QEMU to provision a QEMU guest" >&2
  exit
else
  set -o xtrace
fi

local new_hostname="qemu"
hostnamectl set-hostname $new_hostname

NO_ASK_BECOME_PASS=1 \
ANSIBLE_PLAYBOOK=bootstrap-qemu.yml \
  exec ./bin/ansible \
  --limit qemu \
  -e disk_device=/dev/sda \
  -e root_dir_mnt=/mnt \
  -e new_hostname=$new_hostname \
  -e bootstrap="true" \
  --tags bootstrap \
  $@

# After rebooting:
# cd ~/src/arch-ansible
# ./bin/ansible # This should succeed to the point of secret setup
# gpg --import ~/gpg-keys/private-key.asc
# gpg --import ~/gpg-keys/public-key.asc
# rm -rf ~/gpg-keys
# shutdown -r now # Amongst other reasons this activates gpg-agent
# ssh-add # Adds SSH key to gpg-agent
# cd ~/src/arch-ansible
# ./bin/ansible
