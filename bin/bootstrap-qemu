#! /bin/bash

set -o errexit
set -o nounset

if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]] ; then
  echo "Run ansible in an arch ISO running in QEMU to provision a QEMU guest" >&2
  exit
else
  set -o xtrace
fi

ansible-playbook bootstrap-qemu.yml \
  --verbose \
  -e disk_device=/dev/sda \
  -e root_dir_mnt=/mnt \
  -e new_hostname=qemu \
  $@

ansible-playbook playbook.yml \
  --verbose \
  --inventory hosts.yml \
  --limit qemu \
  --connection chroot \
  -e ansible_host=/mnt \
  -e bootstrap='true' \
  -e appearance=night \
  --tags bootstrap \
  $@

ansible-playbook post-bootstrap-qemu.yml \
  --verbose \
  -e disk_device=/dev/sda \
  -e root_dir_mnt=/mnt \
  -e new_hostname=qemu \
  $@

# After rebooting:
# cd ~/src/arch-ansible
# ./bin/ansible # This should succeed to the point of secret setup
# gpg --import ~/gpg-keys/private-key.asc
# gpg --import ~/gpg-keys/public-key.asc
# rm -rf ~/gpg-keys
# shutdown -r now # Amongst other reasons this activates gpg-agent
# ssh-add # Adds SSH key to gpg-agent
# cd ~/src/arch-ansible
# ./bin/ansible
