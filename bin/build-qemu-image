#! /bin/bash

set -o errexit
set -o nounset

source bin/_common_qemu_args.sh

rm ~/.local/share/qemu-arch-image.qcow2
qemu-img create -f qcow2 ~/.local/share/qemu-arch-image.qcow2 8G
rm ~/.local/share/qemu-arch-usb.iso
qemu-img create -f raw ~/.local/share/qemu-arch-usb.iso 8G

ansible-playbook build-live-usb.yml -v --ask-become-pass \
  -e usb_device=~/.local/share/qemu-arch-usb.iso \
  -e pass_gpg_key="mnussbaum (Password Store)"

cp /usr/share/ovmf/x64/OVMF_VARS.fd /tmp/qemu-arch-uefi-vars.bin

echo "Starting qemu"
exec qemu-system-x86_64 \
  "${common_qemu_args[@]}" \
  -drive file=/home/mnussbaum/.local/share/qemu-arch-image.qcow2,format=qcow2 \
  -cdrom /home/mnussbaum/.local/share/qemu-arch-usb.iso
