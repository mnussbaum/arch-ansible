# vim:ft=yaml.ansible:
---
- hosts: all
  tasks:
    - name: Identify root partition mount point
      set_fact:
        root_dir_mnt: "{{ item.mount_point }}"
      loop: "{{ desired_partitions }}"
      when: item.name == "Arch Root"
      tags: [bootstrap, rebuild-boot-parition, mount-partitions]

- name: Run pre-chroot tasks
  import_playbook: bootstrap-pre-chroot.yml
  tags: [bootstrap, rebuild-boot-parition, mount-partitions]

- hosts: all
  tasks:
    - name: Set facts for chroot playbook execution
      set_fact:
        ansible_host: /mnt
        ansible_connection: chroot
      tags: [bootstrap, rebuild-boot-parition]

- name: Run normal playbook from inside the chroot
  import_playbook: playbook.yml

- name: Run post-chroot tasks
  import_playbook: bootstrap-post-chroot.yml
  tags:
    - bootstrap
